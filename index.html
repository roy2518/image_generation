<!DOCTYPE html>
<html>
<head>
	<title>Testing JS</title>
</head>
<body>
<canvas id="target" width="300" height="300" style="border:1px solid #000000"></canvas>
<canvas id="genetic" width="300" height="300" style="border:1px solid #000000"> </canvas>
<canvas id="dummy" width="300" height="300" style="display:none"></canvas>
<script>

	var target_canvas = document.getElementById("target");
	var target_ctx = target_canvas.getContext("2d");

	var target_image = new Image();
	var target_RGB = [];
	target_image.onload = function()
	{
		target_ctx.drawImage(target_image, 0, 0, target_canvas.width, target_canvas.height);
		target_RGB = target_ctx.getImageData(0, 0, target_canvas.width, target_canvas.height).data;
		Population();
		setInterval(generate, 0);
	}

	target_image.src = "img/night.jpg";

	var genetic_canvas = document.getElementById("genetic");
	var width = genetic_canvas.width;
	var height = genetic_canvas.height;
	var ctx = genetic_canvas.getContext("2d");

	var dummy_ctx = document.getElementById("dummy").getContext("2d");

	var numCircles = 125;
	var gene_length = 7;
	var mutate_chance = 0.01;
	var remove = 0.25;
	var pop_size = 50;

	chromosomes = [];

	//GOOD
	function Population()
	{
		for(var i = 0; i < pop_size; i++)
		{
			var result = Chromosome();
			chromosomes.push({
				dna:result[0],
				fitness:result[1]
			});
		}
	}

	function iterate()
	{

		chromosomes = chromosomes.sort(function(a, b) {
			//Higher fitness is better
			return b.fitness - a.fitness;
		});

		var children = [];

		//Reproduction by roulette selection
		for(var i = 0; i < Math.ceil(.15 * pop_size); i++) //7
		{
			for(var j = 0; j < Math.ceil(1 / .15); j++)
			{
				var random = i;
				while(random == i)
				{
					random = (Math.random() * Math.ceil(.15 * pop_size)) >> 0;
				}
				var result = Chromosome(chromosomes[i], chromosomes[random]);
				children.push({
					dna:result[0],
					fitness:result[1]
				});
			}
		}

		chromosomes = children;
		chromosomes.length = pop_size;

	}

	//GOOD
	function generate()
	{
		iterate();

		chromosomes = chromosomes.sort(function(a, b) {
			//Higher fitness is better
			return b.fitness - a.fitness;
		});

		var fittest = chromosomes[0].dna;
		
		// console.log(chromosomes[0].fitness);

		ctx.fillStyle = "#000";
		ctx.fillRect(0, 0, width, height);

		for(var i = 0; i < fittest.length; i += gene_length)
		{
			ctx.beginPath();
			ctx.arc(fittest[i] * width, fittest[i + 1] * height, fittest[i + 2] * (width * .5), 0, 2 * Math.PI);
			ctx.closePath();
			style = "rgba(" + ((fittest[i + 3] * 255) >> 0) + ", " + ((fittest[i + 4] * 255) >> 0) + ", " + 
				((fittest[i + 5] * 255) >> 0) + ", " + fittest[i + 6] + ")";
			ctx.fillStyle = style;
			ctx.fill();
		}
		
	}

	//GOOD
	function Chromosome(mother, father) 
	{
		this.dna = []
		if(mother && father)
		{
			//Crossover
			for(var i = 0; i < mother.dna.length; i++)
			{
				var gene;
				gene = (Math.random() < 0.5) ? mother.dna : father.dna;

				//Mutations
				var allele = gene[i];
				if(Math.random() < mutate_chance)
				{
					var delta = Math.random() * .1 * 2 - .1;
					if(Math.random() < 0.5)
					{
						allele -= delta;
					}
					else
					{
						allele += delta;
					}
					if(allele < 0)
					{
						allele = 0;
					}

					if(allele > 1)
					{
						allele = 1;
					}
				}
				//Add gene
				this.dna.push(allele);
			}
		}

		else
		{
			for(var i = 0; i < numCircles; i++)
			{
				var X = Math.random();
				if(X < 0.08)
				{
					X = 0.08;
				}
				if(X > 0.92)
				{
					X = 0.92;
				}
				var Y = Math.random();
				if(Y < 0.08)
				{
					Y = 0.08;
				}
				if(Y > 0.92)
				{
					Y = 0.92;
				}
				this.dna.push(X);
				this.dna.push(Y);
				this.dna.push(Math.random() * 0.5); //Radius
				this.dna.push(Math.random()); //R
				this.dna.push(Math.random()); //G
				this.dna.push(Math.random()); //B
				this.dna.push(Math.max(Math.random() * Math.random(), 0.2)); //Transparency
			}
		}

		dummy_ctx.fillStyle = "#000";
		dummy_ctx.fillRect(0, 0, width, height);

		for(var i = 0; i < this.dna.length; i += gene_length)
		{
			dummy_ctx.beginPath();
			dummy_ctx.arc(this.dna[i] * width, this.dna[i + 1] * height, this.dna[i + 2] * (width * .5), 0, 2 * Math.PI);
			dummy_ctx.closePath();
			style = "rgba(" + ((this.dna[i + 3] * 255) >> 0) + ", " + ((this.dna[i + 4] * 255) >> 0) + ", " + 
				((this.dna[i + 5] * 255) >> 0) + ", " + this.dna[i + 6] + ")";
			dummy_ctx.fillStyle = style;
			dummy_ctx.fill();
		}

		my_RGB = dummy_ctx.getImageData(0, 0, genetic_canvas.width, genetic_canvas.height).data;

		this.fitness = 0;
		for(var i = 0; i < my_RGB.length; i++)
		{
			var d = target_RGB[i] - my_RGB[i];
			this.fitness += d * d;
		}

		this.fitness /= my_RGB.length;
		this.fitness = 100 / this.fitness;

		return [this.dna, this.fitness];
	}

	// function testTargetRGB(rand_RGB)
	// {
	// 	console.log(rand_RGB);
	// 	for(var i = 0; i < rand_RGB.length; i += 4)
	// 	{
	// 		style = "rgba(" + rand_RGB[i] + ", " + rand_RGB[i + 1] + ", " + rand_RGB[i + 2] + ", " + rand_RGB[i + 3] + ")";
	// 		ctx.fillStyle = style;
	// 		ctx.fillRect((i / 4) % width, Math.floor((i / 4) / width), 1, 1);
	// 	}
	// }

</script>
</body>
</html>